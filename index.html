<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#0f172a">
<title>NS Fish Trainer</title>
<style>
  :root{
    --bg:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--card:#111827;--chip:#1f2937;--accent:#22c55e;
    --white:#e5e7eb;--blue:#38bdf8;--purple:#a78bfa;--brown:#a16207;--black:#111827;
  }
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(100% 150% at 50% 0%,#1f2937 0%,#0b1020 55%,#000 100%);
    color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;
    display:grid;place-items:start;padding:16px;
  }
  .app{width:min(960px,100%);margin-inline:auto}
  a{color:#7dd3fc;text-decoration:none} a:hover{text-decoration:underline}
  .header{
    display:flex;gap:12px;align-items:center;padding:12px;border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    border:1px solid #273042; position:sticky; top:8px; backdrop-filter:blur(8px); z-index:5;
  }
  .header .icon{font-size:28px;padding:12px;border-radius:50%;background:rgba(56,189,248,.18)}
  .stats{display:flex;gap:14px;color:var(--muted);font-weight:600;flex-wrap:wrap}
  .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .ghost{
    background:rgba(255,255,255,.06);color:var(--ink);
    border:1px solid #273042; font-weight:700; padding:9px 13px; border-radius:12px; cursor:pointer;
  }
  button{transition:transform .05s ease,filter .2s ease;touch-action:manipulation}
  button:active{transform:translateY(1px)}
  .coffee{background:#ffdd00;color:#111;border:0;font-weight:800;padding:9px 13px;border-radius:12px;cursor:pointer}
  .start{margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid #273042}
  .belt{font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid #273042}
  .belt.white{background:rgba(229,231,235,.15);color:#fff}
  .belt.blue{background:rgba(56,189,248,.18)}
  .belt.purple{background:rgba(167,139,250,.18)}
  .belt.brown{background:rgba(161,98,7,.25)}
  .belt.black{background:rgba(17,24,39,.8)}
  .footer{margin-top:14px;color:var(--muted);font-size:.85rem}

  /* Lesson */
  .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:12px}
  .card{position:relative;border-radius:20px;overflow:hidden;background:var(--card);box-shadow:0 10px 40px rgba(0,0,0,.45);margin-top:12px}
  .frame{aspect-ratio:16/9;display:grid;place-items:center;background:#071023;position:relative}
  img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .credit{margin-top:8px;color:var(--muted);font-size:.9rem}
  .q{margin-top:12px;font-weight:800}
  .opts{display:grid;gap:10px;margin-top:10px}
  .opt{padding:12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid #273042;cursor:pointer;text-align:left}
  .opt:hover{filter:brightness(1.05)}
  .opt .sci{color:#cbd5e1;font-style:italic;font-size:.9rem}
  .result{display:flex;gap:8px;align-items:center;margin-top:8px}
  .result.ok{color:#86efac} .result.no{color:#fca5a5}
  .actions{display:flex;gap:10px;margin-top:12px}

  /* Practice card */
  .practice{padding:16px;border-radius:16px;border:1px dashed #475569;background:#0b1221;margin-top:14px}
  .hide{display:none}

  /* About (inline) */
  #aboutSection{margin-top:18px}
  details.about{border:1px solid #273042; border-radius:16px; background:#0b1221; overflow:hidden}
  details.about > summary{list-style:none; cursor:pointer; padding:14px; font-weight:800;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02)); display:flex; gap:10px}
  details.about[open] > summary{border-bottom:1px solid #273042}
  .about-body{padding:16px}
  .about-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
</style>
</head>
<body>
<div class="app">
  <!-- HOME -->
  <section id="home">
    <div class="header">
      <div class="icon">üêü</div>
      <div>
        <div style="font-weight:800;">Freshwater Fish ‚Äî Nova Scotia</div>
        <div class="stats">
          <div>‚ö° <span id="xp">0</span> XP</div>
          <div>üî• Streak <span id="streak">0</span></div>
          <div>ü•ã Rank <span id="rankLabel" class="belt white">White</span></div>
        </div>
      </div>
      <div class="buttons">
        <button class="ghost" id="shareBtn">Share</button>
        <button class="coffee" id="donateBtn">‚òï Buy me a coffee</button>
        <button class="ghost" id="aboutBtn">About & Credits</button>
      </div>
    </div>

    <div class="start">
      <button id="startBtn" class="ghost">Start 50-question run</button>
      <span class="badge">‚ù§Ô∏è <span id="heartsHome">3</span></span>
      <span class="badge">Best: <span id="bestPercent">0%</span></span>
    </div>

    <div id="practiceCard" class="practice hide">
      <div class="row" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Practice your mistakes</strong>
          <div style="color:var(--muted);font-size:.9rem" id="practiceCount">0 species saved</div>
        </div>
        <button id="practiceBtn">Practice mistakes</button>
      </div>
    </div>

    <div class="footer">Tip: Add to Home Screen to use like an app. Works offline after first load.</div>
  </section>

  <!-- QUIZ -->
  <section id="lesson" class="hide">
    <div class="topbar">
      <div class="badge">‚ù§Ô∏è <span id="hearts">3</span></div>
      <div class="badge">Q <span id="qIndex">1</span>/50</div>
      <div class="badge">‚úÖ <span id="correctCount">0</span></div>
    </div>

    <div class="card">
      <div class="frame" id="imgFrame">
        <div id="imgLoader" class="center" style="padding:14px">Loading image‚Ä¶ (tap image to change)</div>
        <img id="img" alt="Fish for ID" class="hide">
      </div>
    </div>
    <div class="credit" id="credit">Image: ‚Äî</div>

    <div class="q">What species is this?</div>
    <div class="opts" id="opts"></div>

    <div class="result" id="result" aria-live="polite"></div>

    <div class="actions">
      <button id="nextBtn" class="ghost">Next</button>
      <button id="quitBtn" class="ghost">Quit</button>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="aboutSection">
    <details id="aboutDetails" class="about">
      <summary>About & Credits</summary>
      <div class="about-body">
        <p style="margin:0 0 10px;color:var(--muted)">
          Images are pulled from Wikipedia and Wikimedia Commons via their public APIs (license-friendly). Tap the image credit to open the source page.
        </p>
        <div class="about-actions">
          <button id="installBtn" class="ghost">Install</button>
          <button id="donateBtn2" class="coffee">‚òï Buy me a coffee</button>
          <button id="shareBtn2" class="ghost">Share</button>
        </div>
      </div>
    </details>
  </section>
</div>

<script>
/*** ---------------------- CONFIG / RANKING ---------------------- ***/
const DONATE_URL = "https://www.paypal.me/evanfay782";

// Belt thresholds
const BELTS = [
  {name:"White",  min:0,   class:"white"},
  {name:"Blue",   min:50,  class:"blue"},
  {name:"Purple", min:65,  class:"purple"},
  {name:"Brown",  min:80,  class:"brown"},
  {name:"Black",  min:90,  class:"black"},
];

/*** ---------------------- DATA ---------------------- ***/
const FISH = [
  S("Brook Trout","Salvelinus fontinalis","Brook trout"),
  S("Yellow Perch","Perca flavescens","Yellow perch"),
  S("White Perch","Morone americana","White perch"),
  S("Smallmouth Bass","Micropterus dolomieu","Smallmouth bass"),
  S("Chain Pickerel","Esox niger","Chain pickerel"),
  S("Pumpkinseed","Lepomis gibbosus","Pumpkinseed"),
  S("Rainbow Trout","Oncorhynchus mykiss","Rainbow trout"),
  S("Brown Trout","Salmo trutta","Brown trout"),
  S("White Sucker","Catostomus commersonii","White sucker"),
  S("American Eel","Anguilla rostrata","American eel"),
  S("Banded Killifish","Fundulus diaphanus","Banded killifish"),
  S("Golden Shiner","Notemigonus crysoleucas","Golden shiner"),
  S("Rainbow Smelt (freshwater)","Osmerus mordax","Rainbow smelt"),
  S("Lake Whitefish","Coregonus clupeaformis","Lake whitefish"),
  S("Threespine Stickleback","Gasterosteus aculeatus","Three-spined stickleback"),
  S("Ninespine Stickleback","Pungitius pungitius","Nine-spined stickleback"),
  S("Splake (hybrid)","Salvelinus namaycush √ó S. fontinalis","Splake"),
  S("Atlantic Salmon (parr)","Salmo salar","Atlantic salmon"),
  S("Blacknose Dace","Rhinichthys atratulus","Blacknose dace"),
  S("Atlantic Whitefish","Coregonus huntsmani","Atlantic whitefish"),
];
function S(common,scientific,wiki){ return {common,scientific,wiki,id:scientific}; }

/*** ---------------------- STATE ---------------------- ***/
const $ = s=>document.querySelector(s);
const home=$("#home"), lesson=$("#lesson");
const xpEl=$("#xp"), streakEl=$("#streak");
const heartsHome=$("#heartsHome");
const rankLabel=$("#rankLabel"), bestPercentEl=$("#bestPercent");
const heartsEl=$("#hearts"), qIndexEl=$("#qIndex"), correctCountEl=$("#correctCount");
const img=$("#img"), imgLoader=$("#imgLoader"), credit=$("#credit");
const opts=$("#opts"), resultEl=$("#result");
const nextBtn=$("#nextBtn"), quitBtn=$("#quitBtn");
const startBtn=$("#startBtn");
const aboutBtn=$("#aboutBtn"), aboutDetails=$("#aboutDetails");
const shareBtn=$("#shareBtn"), shareBtn2=$("#shareBtn2");
const donateBtn=$("#donateBtn"), donateBtn2=$("#donateBtn2");
const practiceCard=$("#practiceCard"), practiceBtn=$("#practiceBtn"), practiceCount=$("#practiceCount");

let store = {
  xp: +localStorage.getItem("xp") || 0,
  streak: +localStorage.getItem("streak") || 0,
  bestPercent: +localStorage.getItem("bestPercent") || 0,
  bestBelt: localStorage.getItem("bestBelt") || "White",
  mistakes: JSON.parse(localStorage.getItem("mistakes")||"[]")
};

function setXP(v){ store.xp=v; localStorage.setItem("xp",v); xpEl.textContent=v; }
function addXP(v){ setXP(store.xp+v); }
function setStreak(v){ store.streak=v; localStorage.setItem("streak",v); streakEl.textContent=v; }
function bumpStreak(correct){ setStreak(correct ? store.streak+1 : 0); }

function beltForPercent(p){
  let b = BELTS[0];
  for(const belt of BELTS){ if(p >= belt.min) b=belt; }
  return b;
}
function renderHeader(){
  xpEl.textContent = store.xp;
  streakEl.textContent = store.streak;
  bestPercentEl.textContent = `${store.bestPercent}%`;
  const b = BELTS.find(x=>x.name===store.bestBelt) || BELTS[0];
  rankLabel.textContent = b.name; rankLabel.className = `belt ${b.class}`;
}
function renderPracticeCard(){
  const count = store.mistakes.length;
  practiceCount.textContent = `${count} ${count===1?"species":"species"} saved`;
  practiceCard.classList.toggle("hide", count===0);
}
renderHeader(); renderPracticeCard();

/*** ---------------------- QUIZ ENGINE (50-question run) ---------------------- ***/
let vm = {
  hearts: 3,
  total: 50,
  idx: 0,
  correct: 0,
  images: [],   // current image set
  imageIdx: 0,  // current index in image set
  q: null
};
function startRun(){
  vm.hearts = 3; vm.idx = 0; vm.correct = 0;
  heartsHome.textContent = '3';
  home.classList.add("hide"); lesson.classList.remove("hide");
  heartsEl.textContent = '3'; qIndexEl.textContent = '1'; correctCountEl.textContent = '0';
  nextBtn.disabled = true; resultEl.textContent = "";
  renderQuestion();
}

function renderQuestion(){
  vm.q = makeQuestion();
  opts.innerHTML = "";
  vm.q.options.forEach(opt=>{
    const b = document.createElement("button");
    b.className="opt";
    b.innerHTML = `<div><strong>${opt.common}</strong></div><div class="sci">${opt.scientific}</div>`;
    b.onclick = ()=>answer(opt);
    opts.appendChild(b);
  });
  resultEl.className="result"; resultEl.textContent="";
  nextBtn.disabled = true;
  // load images (up to 5)
  loadImagesFor(vm.q.fish).then(set => {
    vm.images = set.length ? set : [];
    vm.imageIdx = 0;
    if(vm.images.length){
      showImage(vm.images[0], vm.q.fish);
    }else{
      img.classList.add("hide");
      imgLoader.classList.remove("hide");
      imgLoader.textContent = "No image found ‚Äî you can still answer.";
      credit.innerHTML = "";
    }
  });
}

function makeQuestion(){
  const fish = choice(FISH);
  let others = shuffle(FISH.filter(x=>x.id!==fish.id)).slice(0,3);
  const options = shuffle([fish, ...others]);
  return {fish, options};
}

function answer(chosen){
  const correct = chosen.id === vm.q.fish.id;
  bumpStreak(correct);
  if(correct){
    vm.correct += 1; correctCountEl.textContent = String(vm.correct);
    addXP(10);
    resultEl.className = "result ok"; resultEl.textContent = "Correct!";
    clearMistake(vm.q.fish.id);
  }else{
    vm.hearts -= 1; heartsEl.textContent = String(vm.hearts);
    resultEl.className = "result no"; resultEl.textContent = `Answer: ${vm.q.fish.common}`;
    addMistake(vm.q.fish.id);
  }
  [...opts.children].forEach(b=>b.disabled = true);
  nextBtn.disabled = false;
}

function next(){
  if(vm.hearts <= 0) return finish();
  vm.idx += 1;
  if(vm.idx >= vm.total) return finish();
  qIndexEl.textContent = String(vm.idx+1);
  renderQuestion();
}

function finish(){
  const attempted = vm.idx + 1;
  const pct = Math.round((vm.correct / attempted) * 100);
  const belt = beltForPercent(pct);
  // Save best
  if(pct > (store.bestPercent||0)){ store.bestPercent = pct; localStorage.setItem("bestPercent", pct); }
  if(BELTS.findIndex(b=>b.name===belt.name) > BELTS.findIndex(b=>b.name===store.bestBelt)){
    store.bestBelt = belt.name; localStorage.setItem("bestBelt", belt.name);
  }
  renderHeader();

  showSheet(`
    <h3 style="margin:0 0 6px">Run complete</h3>
    <p style="margin:0 0 8px;color:var(--muted)">
      Score: <strong>${vm.correct}/${attempted}</strong> (${pct}%)
    </p>
    <p>Your belt: <span class="belt ${belt.class}">${belt.name}</span></p>
    <div class="row" style="display:flex;gap:10px;justify-content:flex-end">
      <button class="ghost" id="againBtn">Again</button>
      <button id="homeBtn">Home</button>
    </div>
  `, ({close})=>{
    $("#againBtn").onclick = ()=>{ close(); startRun(); };
    $("#homeBtn").onclick  = ()=>{ close(); goHome(); };
  });
}

function goHome(){
  lesson.classList.add("hide");
  home.classList.remove("hide");
  renderHeader(); renderPracticeCard();
}

/*** ---------------------- MISTAKES ---------------------- ***/
function saveMistakes(){ localStorage.setItem("mistakes", JSON.stringify(store.mistakes)); renderPracticeCard(); }
function addMistake(id){ if(!store.mistakes.includes(id)){ store.mistakes.push(id); saveMistakes(); } }
function clearMistake(id){ const i=store.mistakes.indexOf(id); if(i>=0){ store.mistakes.splice(i,1); saveMistakes(); } }
function startPractice(){
  const pool = FISH.filter(f=>store.mistakes.includes(f.id));
  if(pool.length===0){
    showSheet("<p>No mistakes saved yet. Miss a species during runs and it will appear here.</p><div style='text-align:right'><button id='ok'>OK</button></div>", ({close})=>{$("#ok").onclick=close});
    return;
  }
  // practice behaves like short run with only mistakes pool
  vm.hearts = 3; vm.idx = 0; vm.correct = 0; vm.total = Math.min(12, pool.length);
  home.classList.add("hide"); lesson.classList.remove("hide");
  heartsEl.textContent = '3'; qIndexEl.textContent = '1'; correctCountEl.textContent = '0';
  nextBtn.disabled = true; resultEl.textContent = "";
  vm.makeFromPool = ()=> {
    const fish = choice(pool);
    let others = shuffle((pool.length>3?pool:FISH).filter(x=>x.id!==fish.id)).slice(0,3);
    return {fish, options:shuffle([fish,...others])};
  };
  renderQuestionFromPool();
}
function renderQuestionFromPool(){
  vm.q = vm.makeFromPool();
  opts.innerHTML = "";
  vm.q.options.forEach(opt=>{
    const b = document.createElement("button");
    b.className="opt";
    b.innerHTML = `<div><strong>${opt.common}</strong></div><div class="sci">${opt.scientific}</div>`;
    b.onclick = ()=>answer(opt);
    opts.appendChild(b);
  });
  resultEl.className="result"; resultEl.textContent=""; nextBtn.disabled = true;
  loadImagesFor(vm.q.fish).then(set => {
    vm.images = set; vm.imageIdx = 0;
    if(vm.images.length){ showImage(vm.images[0], vm.q.fish); }
    else { img.classList.add("hide"); imgLoader.classList.remove("hide"); imgLoader.textContent = "No image found ‚Äî you can still answer."; credit.innerHTML=""; }
  });
}
function nextPractice(){
  if(vm.hearts <= 0) return goHome();
  vm.idx += 1;
  if(vm.idx >= vm.total) return goHome();
  qIndexEl.textContent = String(vm.idx+1);
  renderQuestionFromPool();
}

/*** ---------------------- IMAGE PIPELINE ---------------------- ***/
// Get up to 5 image URLs for a species using Wikipedia + Commons (no keys, CORS-safe)
async function loadImagesFor(fish){
  // Step A: get images attached to the species page
  const titlesUrl = `https://en.wikipedia.org/w/api.php?origin=*&action=query&titles=${encodeURIComponent(fish.wiki)}&prop=images&imlimit=max&format=json`;
  let fileTitles = [];
  try{
    const r = await fetch(titlesUrl);
    const j = await r.json();
    const page = Object.values(j.query.pages)[0];
    fileTitles = (page.images||[]).map(im=>im.title).filter(name=>{
      const n = name.toLowerCase();
      const goodExt = /\.(jpg|jpeg|png)$/i.test(n);
      const bad = ['map','range','distribution','logo','icon','vector','diagram','svg'];
      return goodExt && !bad.some(b=>n.includes(b));
    });
  }catch(_){}
  // Step B: fetch URLs for up to 5 files
  let urls = [];
  if(fileTitles.length){
    const batch = fileTitles.slice(0,12).join('|');
    try{
      const infoUrl = `https://en.wikipedia.org/w/api.php?origin=*&action=query&titles=${encodeURIComponent(batch)}&prop=imageinfo&iiprop=url&iiurlwidth=1200&format=json`;
      const r2 = await fetch(infoUrl);
      const j2 = await r2.json();
      const pages = Object.values(j2.query.pages||{});
      urls = pages.map(p=>p.imageinfo?.[0]?.thumburl || p.imageinfo?.[0]?.url).filter(Boolean).slice(0,5);
    }catch(_){}
  }
  // Step C: fallback to summary image if nothing
  if(!urls.length){
    const sum = await summaryImage(fish.wiki);
    if(sum) urls = [sum];
  }
  return urls;
}

async function summaryImage(title){
  try{
    const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`, {mode:'cors', cache:'force-cache'});
    if(!r.ok) return null;
    const j = await r.json();
    return j.originalimage?.source || j.thumbnail?.source || null;
  }catch(_){ return null; }
}

function showImage(src, fish){
  img.src = src; img.alt = `Identify this fish: ${fish.common}`;
  img.onload = ()=>{
    imgLoader.classList.add("hide");
    img.classList.remove("hide");
    credit.innerHTML = `Image via <a href="https://en.wikipedia.org/wiki/${encodeURIComponent(fish.wiki)}" target="_blank" rel="noopener">Wikipedia/Commons</a> ‚Äî tap image to change`;
  };
  img.onerror = ()=>{
    img.classList.add("hide");
    imgLoader.classList.remove("hide");
    imgLoader.textContent = "Image failed to load ‚Äî tap Next.";
    credit.innerHTML = "";
  };
}

// Tap image to cycle through fetched set
$("#imgFrame").addEventListener('click', ()=>{
  if(!vm.images.length) return;
  vm.imageIdx = (vm.imageIdx + 1) % vm.images.length;
  showImage(vm.images[vm.imageIdx], vm.q.fish);
});

/*** ---------------------- UI HELPERS ---------------------- ***/
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function showSheet(html, wire){
  const modal = document.createElement("div");
  modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,.6)';
  modal.style.display='grid'; modal.style.placeItems='center'; modal.style.padding='16px'; modal.style.zIndex='50';
  modal.innerHTML = `<div style="width:min(520px,100%);background:#0b1221;border:1px solid #273042;border-radius:16px;padding:18px">${html}</div>`;
  document.body.appendChild(modal);
  const close = ()=>{ modal.remove(); };
  modal.addEventListener('click', e=>{ if(e.target===modal) close(); });
  wire?.({close});
}

/*** ---------------------- EVENTS ---------------------- ***/
startBtn.addEventListener('click', ()=>{ vm.total = 50; startRun(); });
nextBtn.addEventListener('click', ()=> vm.makeFromPool ? nextPractice() : next());
quitBtn.addEventListener('click', goHome);

// About button opens inline details
aboutBtn.addEventListener('click', () => { aboutDetails.open = true; aboutDetails.scrollIntoView({behavior:'smooth'}); });

// Donate
donateBtn.onclick = ()=> window.open(DONATE_URL, "_blank", "noopener");
donateBtn2.onclick = ()=> window.open(DONATE_URL, "_blank", "noopener");

// Practice
practiceBtn.onclick = ()=> startPractice();

// Share (header + about)
function doShare(){
  const shareData = { title:"NS Fish Trainer", text:"Duolingo-style Nova Scotia fish ID trainer üêü", url: window.location.href };
  if (navigator.share) { navigator.share(shareData).catch(()=>{}); }
  else {
    navigator.clipboard.writeText(window.location.href).then(()=> {
      showSheet(`<p style="margin:0 0 10px">Link copied! Paste it anywhere to share.</p>
                 <div style="text-align:right"><button id="okClose">OK</button></div>`,
        ({close})=>{ $("#okClose").onclick = close; });
    });
  }
}
shareBtn.onclick = doShare; shareBtn2.onclick = doShare;

/*** ---------------------- PWA bits (manifest + SW + install) ---------------------- ***/
const manifest = { name:"NS Fish Trainer", short_name:"NS Fish", start_url:"./", display:"standalone",
  background_color:"#0f172a", theme_color:"#0f172a",
  icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='28' fill='%230f172a'/%3E%3Cpath d='M20 70c18-14 36-22 56-22 8 0 16 6 24 12-8 6-16 12-24 12-18 0-32 6-44 16l-12-18z' fill='%2322c55e'/%3E%3Ccircle cx='84' cy='56' r='5' fill='%23000'/%3E%3C/svg%3E",sizes:"128x128", type:"image/svg+xml"}] };
const mblob = new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"});
const murl = URL.createObjectURL(mblob);
const mlink = document.createElement('link'); mlink.rel='manifest'; mlink.href=murl; document.head.appendChild(mlink);

if('serviceWorker' in navigator){
  const swCode = `
    const CACHE='ns-fish-v1';
    self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./']))); self.skipWaiting(); });
    self.addEventListener('activate',e=> self.clients.claim());
    self.addEventListener('fetch',e=>{
      const req=e.request;
      if(req.destination==='image' || req.url.includes('wikipedia.org') || req.url.includes('wikimedia.org')){
        e.respondWith(fetch(req).then(r=>{const copy=r.clone();caches.open(CACHE).then(c=>c.put(req,copy));return r;}).catch(()=>caches.match(req)));
      }else{
        e.respondWith(caches.match(req).then(hit=>hit||fetch(req)));
      }
    });
  `;
  const blob = new Blob([swCode],{type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

// Install prompt (Android/Chrome) + iOS instruction sheet
let deferredPrompt=null, installBtn=$("#installBtn");
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.textContent="Install app";
  if(installBtn){
    installBtn.onclick=async ()=>{
      if(!deferredPrompt) return;
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
    };
  }
});
if(/iphone|ipad|ipod/i.test(navigator.userAgent) && installBtn){
  installBtn.addEventListener('click', () => {
    showSheet(`<p style="margin:0 0 10px">On iPhone/iPad: tap the Share button, then ‚ÄúAdd to Home Screen‚Äù.</p>
               <div style="text-align:right"><button id="ok">OK</button></div>`,
      ({close})=>{ $("#ok").onclick = close; });
  });
}

/*** ---------------------- INIT ---------------------- ***/
function initKeyboard(){
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='n' && !nextBtn.disabled) (vm.makeFromPool?nextPractice():next)();
    if(e.key.toLowerCase()==='h') goHome();
  });
}
initKeyboard();
</script>
</body>
</html>
