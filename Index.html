<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#0f172a">
<title>NS Fish Trainer</title>
<style>
  :root{
    --bg:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--card:#111827;--chip:#1f2937;--accent:#22c55e;
    --beg:#22c55e;--nov:#38bdf8;--mas:#a78bfa;--gm:#f59e0b;
  }
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(100% 150% at 50% 0%,#1f2937 0%,#0b1020 55%,#000 100%);
    color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;
    display:grid;place-items:center;padding:16px;
  }
  .app{width:min(960px,100%);}
  a{color:#7dd3fc;text-decoration:none} a:hover{text-decoration:underline}
  .header{
    display:flex;gap:12px;align-items:center;padding:12px;border-radius:16px;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    border:1px solid #273042;
  }
  .header .icon{font-size:28px;padding:12px;border-radius:50%;background:rgba(56,189,248,.18)}
  .stats{display:flex;gap:14px;color:var(--muted);font-weight:600;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px}
  .level{padding:16px;border-radius:16px;border:1px solid #273042;cursor:pointer;transition:transform .06s ease}
  .level:hover{transform:translateY(-1px)} .level h3{margin:0 0 6px}
  .lvl-beg{background:color-mix(in oklab,var(--beg) 18%, transparent)}
  .lvl-nov{background:color-mix(in oklab,var(--nov) 18%, transparent)}
  .lvl-mas{background:color-mix(in oklab,var(--mas) 18%, transparent)}
  .lvl-gm{background:color-mix(in oklab,var(--gm) 18%, transparent)}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .hide{display:none}
  .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

  .ghost{
    background:rgba(255,255,255,.06);color:var(--ink);
    border:1px solid #273042; font-weight:700; padding:9px 13px; border-radius:12px; cursor:pointer;
  }
  button{transition:transform .05s ease,filter .2s ease;touch-action:manipulation}
  button:active{transform:translateY(1px)}
  .coffee{
    background:#ffdd00;color:#111;border:0;font-weight:800;padding:9px 13px;border-radius:12px;cursor:pointer;
  }

  /* Lesson */
  .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid #273042}
  .card{position:relative;border-radius:20px;overflow:hidden;background:var(--card);box-shadow:0 10px 40px rgba(0,0,0,.45);margin-top:12px}
  .frame{aspect-ratio:16/9;display:grid;place-items:center;background:#071023}
  img{max-width:100%;max-height:100%;object-fit:contain;display:block}
  .credit{margin-top:8px;color:var(--muted);font-size:.9rem}
  .q{margin-top:12px;font-weight:800}
  .opts{display:grid;gap:10px;margin-top:10px}
  .opt{padding:12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid #273042;cursor:pointer;text-align:left}
  .opt:hover{filter:brightness(1.05)}
  .opt .sci{color:#cbd5e1;font-style:italic;font-size:.9rem}
  .result{display:flex;gap:8px;align-items:center;margin-top:8px}
  .result.ok{color:#86efac} .result.no{color:#fca5a5}
  .actions{display:flex;gap:10px;margin-top:12px}
  .footer{margin-top:14px;color:var(--muted);font-size:.85rem}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;padding:16px;z-index:20}
  .sheet{width:min(520px,100%);background:#0b1221;border:1px solid #273042;border-radius:16px;padding:18px}

  /* Practice Mistakes button */
  .practice{padding:16px;border-radius:16px;border:1px dashed #475569;background:#0b1221}
</style>
</head>
<body>
<div class="app">
  <!-- HOME -->
  <section id="home">
    <div class="header">
      <div class="icon">üêü</div>
      <div>
        <div style="font-weight:800;">Freshwater Fish ‚Äî Nova Scotia</div>
        <div class="stats">
          <div>‚ö° <span id="xp">0</span> XP</div>
          <div>üî• Streak <span id="streak">0</span></div>
          <div>üîì <span id="unlocked">Beginner</span></div>
        </div>
      </div>
      <div class="buttons">
        <button class="ghost" id="shareBtn">Share</button>
        <button class="coffee" id="donateBtn">‚òï Buy me a coffee</button>
        <button class="ghost" id="aboutBtn">About & Credits</button>
      </div>
    </div>

    <div id="practiceCard" class="practice hide">
      <div class="row">
        <div>
          <strong>Practice your mistakes</strong>
          <div style="color:var(--muted);font-size:.9rem" id="practiceCount">0 species saved</div>
        </div>
        <button id="practiceBtn">Practice mistakes</button>
      </div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="level lvl-beg" data-level="beginner">
        <h3>Beginner</h3>
        <div class="row"><div>8 questions ‚Ä¢ 3 hearts</div><div>‚Üí</div></div>
      </div>
      <div class="level lvl-nov" data-level="novice">
        <h3>Novice</h3>
        <div class="row"><div>10 questions ‚Ä¢ 3 hearts</div><div>‚Üí</div></div>
      </div>
      <div class="level lvl-mas" data-level="master">
        <h3>Master</h3>
        <div class="row"><div>12 questions ‚Ä¢ 3 hearts</div><div>‚Üí</div></div>
      </div>
      <div class="level lvl-gm" data-level="grandMaster">
        <h3>Grand Master</h3>
        <div class="row"><div>12 questions ‚Ä¢ 3 hearts</div><div>‚Üí</div></div>
      </div>
    </div>

    <div class="footer">Tip: Add to Home Screen to use like an app. Works offline after first load.</div>
  </section>

  <!-- LESSON -->
  <section id="lesson" class="hide">
    <div class="topbar">
      <div class="badge">‚ù§Ô∏è <span id="hearts">3</span></div>
      <div class="badge" id="levelName">Beginner</div>
      <div class="badge">Q <span id="qIndex">1</span>/<span id="qTotal">8</span></div>
    </div>

    <div class="card">
      <div class="frame" id="imgFrame">
        <div id="imgLoader" class="center" style="padding:14px">Loading image‚Ä¶</div>
        <img id="img" alt="Fish for ID" class="hide">
      </div>
    </div>
    <div class="credit" id="credit">Image: ‚Äî</div>

    <div class="q">What species is this?</div>
    <div class="opts" id="opts"></div>

    <div class="result" id="result" aria-live="polite"></div>

    <div class="actions">
      <button id="nextBtn" class="ghost">Next</button>
      <button id="quitBtn" class="ghost">Quit</button>
    </div>
  </section>
</div>

<!-- ABOUT MODAL -->
<div id="aboutModal" class="modal hide">
  <div class="sheet">
    <h3 style="margin:0 0 6px">About & Credits</h3>
    <p style="margin:0 0 10px;color:var(--muted)">
      Images are fetched from Wikipedia/Wikimedia for each species. Tap the image credit to open the page and see license/author.
      Data includes native, introduced, stocked, and invasive freshwater species found in Nova Scotia (educational use only).
    </p>
    <div class="row">
      <button id="installBtn" class="ghost">Install</button>
      <button id="donateBtn2" class="coffee">‚òï Buy me a coffee</button>
      <div style="margin-left:auto"><button id="closeAbout">Close</button></div>
    </div>
  </div>
</div>

<script>
/*** ---------------------- CONFIG ---------------------- ***/
const DONATE_URL = "https://www.paypal.me/evanfay782"; // your PayPal link

/*** ---------------------- DATA ---------------------- ***/
// Status: "native" | "introduced" | "stocked" | "invasive"
const Difficulty = {
  beginner: {title:"Beginner", questions:8,  color:"var(--beg)"},
  novice:   {title:"Novice",   questions:10, color:"var(--nov)"},
  master:   {title:"Master",   questions:12, color:"var(--mas)"},
  grandMaster:{title:"Grand Master", questions:12, color:"var(--gm)"},
};
const order = ["beginner","novice","master","grandMaster"];

const FISH = [
  // Beginner
  S("Brook Trout","Salvelinus fontinalis","Brook trout",["native"],"beginner",["salmonid"]),
  S("Yellow Perch","Perca flavescens","Yellow perch",["native"],"beginner",["perch"]),
  S("White Perch","Morone americana","White perch",["native"],"beginner",["lakes/slow rivers"]),
  S("Smallmouth Bass","Micropterus dolomieu","Smallmouth bass",["introduced","invasive"],"beginner",["sunfish"]),
  S("Chain Pickerel","Esox niger","Chain pickerel",["introduced","invasive"],"beginner",["pike family"]),
  S("Pumpkinseed","Lepomis gibbosus","Pumpkinseed",["introduced"],"beginner",["sunfish"]),
  S("Rainbow Trout","Oncorhynchus mykiss","Rainbow trout",["introduced","stocked"],"beginner",["stocked"]),
  S("Brown Trout","Salmo trutta","Brown trout",["introduced","stocked"],"beginner",["naturalized"]),
  // Novice
  S("White Sucker","Catostomus commersonii","White sucker",["native"],"novice",["sucker"]),
  S("American Eel","Anguilla rostrata","American eel",["native"],"novice",["catadromous"]),
  S("Banded Killifish","Fundulus diaphanus","Banded killifish",["native"],"novice",["weedy shallows"]),
  S("Golden Shiner","Notemigonus crysoleucas","Golden shiner",["native"],"novice",["baitfish"]),
  S("Rainbow Smelt (freshwater)","Osmerus mordax","Rainbow smelt",["native"],"novice",["landlocked/anadromous"]),
  // Master
  S("Lake Whitefish","Coregonus clupeaformis","Lake whitefish",["native"],"master",["whitefish"]),
  S("Threespine Stickleback","Gasterosteus aculeatus","Three-spined stickleback",["native"],"master",["coastal & inland"]),
  S("Ninespine Stickleback","Pungitius pungitius","Nine-spined stickleback",["native"],"master",["ponds"]),
  S("Splake (hybrid)","Salvelinus namaycush √ó S. fontinalis","Splake",["stocked"],"master",["hybrid"]),
  // Grand Master
  S("Atlantic Salmon (parr)","Salmo salar","Atlantic salmon",["native"],"grandMaster",["juvenile ID"]),
  S("Blacknose Dace","Rhinichthys atratulus","Blacknose dace",["native"],"grandMaster",["minnow"]),
  S("Atlantic Whitefish","Coregonus huntsmani","Atlantic whitefish",["native"],"grandMaster",["endemic"]),
];
function S(common,scientific,wiki,statuses,difficulty,tags){ return {common,scientific,wiki,statuses,difficulty,tags,id:scientific}; }

/*** ---------------------- STATE ---------------------- ***/
const $ = s=>document.querySelector(s);
const home=$("#home"), lesson=$("#lesson");
const xpEl=$("#xp"), streakEl=$("#streak"), unlockedEl=$("#unlocked");
const heartsEl=$("#hearts"), levelName=$("#levelName"), qIndexEl=$("#qIndex"), qTotalEl=$("#qTotal");
const img=$("#img"), imgLoader=$("#imgLoader"), credit=$("#credit");
const opts=$("#opts"), resultEl=$("#result");
const nextBtn=$("#nextBtn"), quitBtn=$("#quitBtn");
const aboutBtn=$("#aboutBtn"), aboutModal=$("#aboutModal"), closeAbout=$("#closeAbout"), installBtn=$("#installBtn");
const shareBtn=$("#shareBtn"), donateBtn=$("#donateBtn"), donateBtn2=$("#donateBtn2");
const practiceCard=$("#practiceCard"), practiceBtn=$("#practiceBtn"), practiceCount=$("#practiceCount");

let store = {
  xp: +localStorage.getItem("xp") || 0,
  streak: +localStorage.getItem("streak") || 0,
  unlocked: localStorage.getItem("unlocked") || "beginner",
  mistakes: JSON.parse(localStorage.getItem("mistakes")||"[]") // array of fish ids (scientific names)
};
renderStats(); renderPracticeCard();

function saveMistakes(){ localStorage.setItem("mistakes", JSON.stringify(store.mistakes)); renderPracticeCard(); }
function addMistake(id){ if(!store.mistakes.includes(id)){ store.mistakes.push(id); saveMistakes(); } }
function clearMistake(id){ const i=store.mistakes.indexOf(id); if(i>=0){ store.mistakes.splice(i,1); saveMistakes(); } }

function setXP(v){ store.xp=v; localStorage.setItem("xp",v); xpEl.textContent=v; }
function addXP(v){ setXP(store.xp+v); }
function setStreak(v){ store.streak=v; localStorage.setItem("streak",v); streakEl.textContent=v; }
function bumpStreak(correct){ setStreak(correct ? store.streak+1 : 0); }
function unlockIfNeeded(levelKey){
  if(order.indexOf(levelKey) > order.indexOf(store.unlocked)){
    store.unlocked = levelKey; localStorage.setItem("unlocked", levelKey);
  }
  unlockedEl.textContent = Difficulty[store.unlocked].title;
}
function renderStats(){
  xpEl.textContent = store.xp;
  streakEl.textContent = store.streak;
  unlockedEl.textContent = Difficulty[store.unlocked].title;
  document.querySelectorAll(".level").forEach(el=>{
    const key = el.dataset.level;
    const locked = order.indexOf(key) > order.indexOf(store.unlocked);
    el.style.opacity = locked ? .55 : 1;
    el.style.pointerEvents = locked ? "none" : "auto";
  });
}
function renderPracticeCard(){
  const count = store.mistakes.length;
  practiceCount.textContent = `${count} ${count===1?"species":"species"} saved`;
  practiceCard.classList.toggle("hide", count===0);
}

/*** ---------------------- QUIZ ENGINE ---------------------- ***/
let vm = {
  mode: "level",       // "level" | "practice"
  levelKey: "beginner",
  hearts: 3,
  questions: [],
  idx: 0,
  currentImage: null
};
function startPractice(){
  const pool = FISH.filter(f=>store.mistakes.includes(f.id));
  if(pool.length===0){ showSheet("<p>No mistakes saved yet. Miss a species in lessons and it will appear here.</p><div class='row' style='margin-top:8px'><div></div><div style='margin-left:auto'><button id='ok'>OK</button></div></div>", ({close})=>{$("#ok").onclick=close}); return; }
  vm.mode="practice"; startLessonInternal(pool, "Practice");
}
function startLesson(levelKey){
  vm.mode="level";
  const pool = FISH.filter(f=>f.difficulty===levelKey);
  startLessonInternal(pool, Difficulty[levelKey].title, levelKey);
}
function startLessonInternal(pool, title, levelKey=null){
  vm.levelKey = levelKey || "practice";
  vm.hearts = 3;
  const count = (vm.mode==="practice") ? Math.min(12, pool.length) : Math.min(Difficulty[levelKey].questions, pool.length);
  const picks = shuffle(pool).slice(0,count);
  vm.questions = picks.map(f=>{
    let others = pool.filter(o=>o.id!==f.id);
    if(others.length < 3) others = FISH.filter(o=>o.id!==f.id);
    const options = shuffle([f, ...shuffle(others).slice(0,3)]);
    return {fish:f, options};
  });
  vm.idx = 0;

  home.classList.add("hide"); lesson.classList.remove("hide");
  levelName.textContent = title;
  qTotalEl.textContent = String(vm.questions.length);
  heartsEl.textContent = String(vm.hearts);
  resultEl.textContent = "";
  nextBtn.disabled = true;
  loadImage();
  renderQ();
}

function renderQ(){
  qIndexEl.textContent = String(vm.idx+1);
  const q = vm.questions[vm.idx];
  opts.innerHTML = "";
  q.options.forEach(opt=>{
    const b = document.createElement("button");
    b.className="opt";
    b.innerHTML = `<div><strong>${opt.common}</strong></div><div class="sci">${opt.scientific}</div>`;
    b.onclick = ()=>answer(opt);
    opts.appendChild(b);
  });
  resultEl.className="result"; resultEl.textContent="";
  nextBtn.disabled = true;
}

async function loadImage(){
  const q = vm.questions[vm.idx];
  img.classList.add("hide"); imgLoader.classList.remove("hide");
  credit.textContent = "Loading image‚Ä¶";
  const info = await wikiImage(q.fish.wiki);
  if(info.url){
    img.src = info.url;
    img.alt = `Identify this fish: ${q.fish.common}`;
    img.onload = ()=>{
      imgLoader.classList.add("hide");
      img.classList.remove("hide");
      credit.innerHTML = `Image via <a href="${info.page}" target="_blank" rel="noopener">Wikipedia</a>`;
    };
    img.onerror = ()=>{
      imgLoader.classList.add("hide");
      credit.innerHTML = `<span style="color:#fca5a5">No image available</span>`;
    };
  }else{
    imgLoader.classList.add("hide");
    credit.innerHTML = `<span style="color:#fca5a5">No image available</span>`;
  }
}

function answer(chosen){
  const q = vm.questions[vm.idx];
  const correct = chosen.id === q.fish.id;
  bumpStreak(correct);
  if(correct){
    addXP(10);
    resultEl.className = "result ok";
    resultEl.textContent = "Correct!";
    // if practicing, remove from mistakes; if in lesson and user previously missed it, also clear
    clearMistake(q.fish.id);
  }else{
    vm.hearts -= 1; heartsEl.textContent = String(vm.hearts);
    resultEl.className = "result no";
    resultEl.textContent = `Answer: ${q.fish.common}`;
    addMistake(q.fish.id); // track for practice
  }
  [...opts.children].forEach(b=>b.disabled = true);
  nextBtn.disabled = false;
}

function next(){
  if(vm.hearts <= 0){ return finish(false); }
  vm.idx += 1;
  if(vm.idx >= vm.questions.length){ return finish(true); }
  renderQ(); loadImage();
}

function finish(passed){
  if(vm.mode==="level" && passed && vm.hearts > 0){
    const nextIdx = Math.min(order.indexOf(vm.levelKey)+1, order.length-1);
    unlockIfNeeded(order[nextIdx]);
    addXP( (Difficulty[vm.levelKey].questions) * 5 ); // small bonus
  }
  showSheet(`
    <h3 style="margin:0 0 6px">${passed? "Nice work!" : "Out of hearts"}</h3>
    <p style="margin:0 0 12px;color:var(--muted)">
      ${vm.mode==="practice" ? "Practice session complete." :
        (passed? "Lesson complete. XP awarded; next tier may be unlocked." : "Give it another shot ‚Äî you‚Äôve got this.")}
    </p>
    <div class="row">
      <button class="ghost" id="againBtn">${vm.mode==="practice"?"Practice again":"Try again"}</button>
      <div style="margin-left:auto"><button id="homeBtn">Home</button></div>
    </div>
  `, ({close})=>{
    $("#againBtn").onclick = ()=>{ close(); vm.mode==="practice" ? startPractice() : startLesson(vm.levelKey); };
    $("#homeBtn").onclick  = ()=>{ close(); goHome(); };
  });
}

function goHome(){
  lesson.classList.add("hide");
  home.classList.remove("hide");
  renderStats(); renderPracticeCard();
}

/*** ---------------------- WIKIPEDIA IMAGE ---------------------- ***/
async function wikiImage(title){
  const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
  try{
    const r = await fetch(url, {mode:'cors', cache:'force-cache'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    const original = j.originalimage?.source;
    const thumb = j.thumbnail?.source;
    const page = j.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`;
    return { url: original || thumb || null, page };
  }catch(e){
    return { url:null, page:`https://en.wikipedia.org/wiki/${encodeURIComponent(title)}` };
  }
}

/*** ---------------------- UI HELPERS ---------------------- ***/
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function showSheet(html, wire){
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.innerHTML = `<div class="sheet">${html}</div>`;
  document.body.appendChild(modal);
  const close = ()=>{ modal.remove(); };
  modal.addEventListener('click', e=>{ if(e.target===modal) close(); });
  wire?.({close});
}

/*** ---------------------- EVENTS ---------------------- ***/
document.querySelectorAll(".level").forEach(el=>{
  el.addEventListener('click', ()=> startLesson(el.dataset.level));
});
nextBtn.addEventListener('click', next);
quitBtn.addEventListener('click', goHome);
aboutBtn.onclick = ()=> aboutModal.classList.remove("hide");
closeAbout.onclick = ()=> aboutModal.classList.add("hide");
donateBtn.onclick = ()=> window.open(DONATE_URL, "_blank", "noopener");
donateBtn2.onclick = ()=> window.open(DONATE_URL, "_blank", "noopener");
practiceBtn.onclick = ()=> startPractice();

// Share button
shareBtn.onclick = async ()=>{
  const shareData = {
    title: "NS Fish Trainer",
    text: "Duolingo-style Nova Scotia fish ID trainer üêü",
    url: window.location.href
  };
  if (navigator.share) {
    try { await navigator.share(shareData); } catch(_) {}
  } else {
    try {
      await navigator.clipboard.writeText(window.location.href);
      showSheet(`<p style="margin:0 0 10px">Link copied! Paste it anywhere to share.</p>
                 <div class="row"><div></div><div style="margin-left:auto"><button id="okClose">OK</button></div></div>`,
        ({close})=>{ $("#okClose").onclick = close; });
    } catch {
      showSheet(`<p style="margin:0 0 10px">Couldn‚Äôt copy automatically. Here‚Äôs the link:</p>
                 <input value="${window.location.href}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #273042;background:#0b1221;color:#e5e7eb" />
                 <div class="row" style="margin-top:10px"><div></div><div style="margin-left:auto"><button id="okClose2">OK</button></div></div>`,
        ({close})=>{ $("#okClose2").onclick = close; });
    }
  }
};

/*** ---------------------- PWA: manifest + SW + install ---------------------- ***/
// dynamic manifest
const manifest = {
  name:"NS Fish Trainer",
  short_name:"NS Fish",
  start_url:"./",
  display:"standalone",
  background_color:"#0f172a",
  theme_color:"#0f172a",
  icons:[{
    src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='28' fill='%230f172a'/%3E%3Cpath d='M20 70c18-14 36-22 56-22 8 0 16 6 24 12-8 6-16 12-24 12-18 0-32 6-44 16l-12-18z' fill='%2322c55e'/%3E%3Ccircle cx='84' cy='56' r='5' fill='%23000'/%3E%3C/svg%3E",
    sizes:"128x128", type:"image/svg+xml"}]
};
const mblob = new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"});
const murl = URL.createObjectURL(mblob);
const mlink = document.createElement('link'); mlink.rel='manifest'; mlink.href=murl; document.head.appendChild(mlink);

// service worker (cache app shell; network-first for images)
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE='ns-fish-v1';
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('activate',e=> self.clients.claim());
    self.addEventListener('fetch',e=>{
      const req=e.request;
      if(req.destination==='image' || req.url.includes('wikipedia.org')){
        e.respondWith(fetch(req).then(r=>{const copy=r.clone();caches.open(CACHE).then(c=>c.put(req,copy));return r;}).catch(()=>caches.match(req)));
      }else{
        e.respondWith(caches.match(req).then(hit=>hit||fetch(req)));
      }
    });
  `;
  const blob = new Blob([swCode],{type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

// install prompt (Android/Chrome); iOS uses Share ‚Üí Add to Home Screen
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault(); deferredPrompt=e; installBtn.textContent="Install app"; installBtn.onclick=async ()=>{
    if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
  };
});

/*** ---------------------- START ---------------------- ***/
function initKeyboard(){
  // N = Next, H = Home
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='n' && !nextBtn.disabled) next();
    if(e.key.toLowerCase()==='h') goHome();
  });
}
renderStats(); renderPracticeCard(); initKeyboard();
</script>
</body>
</html>
